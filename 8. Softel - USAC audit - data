# USAC AUDIT
# 15
WITH t1 AS
(SELECT
	DATE_FORMAT(c.created_at,"%Y-%m-%d") AS created_at,
	c.id AS customer_id,
	c.enrollment_id
FROM oss_customers c 
WHERE c.created_at >= '2022-01-01'
),

t2 AS 
(SELECT
	t.enrollment_id,
	min(t.nlad_transaction_date) AS min_transaction_date,
	t.id AS transaction_id,
	t.transaction_type 
FROM oss_nlad_transactions t 
WHERE t.enrollment_type IN ('EBB', 'ACP')
GROUP BY 1
),
t3 AS
(SELECT
	t1.customer_id,
	t1.created_at,
	t1.enrollment_id,
	t2.min_transaction_date,
	t2.transaction_id,
	t2.transaction_type
FROM t1 
LEFT JOIN t2 ON t1.enrollment_id = t2.enrollment_id
),
	
t4 AS
(
SELECT
	CASE 
		WHEN t3.created_at < t3.min_transaction_date THEN t3.created_at 
		WHEN t3.created_at > t3.min_transaction_date THEN t3.min_transaction_date 
		WHEN t3.created_at = t3.min_transaction_date THEN t3.created_at
		WHEN t3.min_transaction_date IS NULL THEN t3.created_at
		ELSE NULL END AS created_date,
		t3.customer_id,
		t3.enrollment_id
FROM t3 
)

SELECT
	DATE_FORMAT(t4.created_date,"%Y-%m") AS month_create,
	count(DISTINCT t4.enrollment_id) AS nb_customers
FROM t4
GROUP BY 1
ORDER BY 1 ASC

--------------------------------------------

#16.b
WITH t1 AS 
(SELECT
	o.enrollment_id,
	MAX(o.nlad_transaction_date) AS max_transaction_date,
	o.tribal_benefit_flag
FROM oss_nlad_transactions o 
WHERE o.enrollment_type IN ('EBB', 'ACP') AND o.transaction_type = 'TRANSFERIN' AND o.nlad_transaction_date >= '2022-01-01' 
GROUP BY 1
),
t2 AS
(SELECT
	e.id AS enrollment_id,
	e.enrollment_id AS enrollment_code,
	e.first_name,
	e.middle_name,
	e.last_name,
	e.address_1,
	e.email,
	e.ebb_subscriber_id,
	c.mdn_active
FROM oss_enrollments e
LEFT JOIN oss_customers c ON c.enrollment_id = e.id
)

SELECT 
	t1.enrollment_id,
	t2.first_name,
	t2.middle_name,
	t2.last_name,
	t2.address_1,
	t2.mdn_active,
	t2.ebb_subscriber_id,
	t1.tribal_benefit_flag
FROM t1 
LEFT JOIN t2 ON t1.enrollment_id = t2.enrollment_id
