# USAC AUDIT
# 15
WITH t1 AS
(SELECT
	DATE_FORMAT(c.created_at,"%Y-%m-%d") AS created_at,
	c.id AS customer_id,
	c.enrollment_id
FROM oss_customers c 
WHERE c.created_at >= '2022-01-01'
),

t2 AS 
(SELECT
	t.enrollment_id,
	min(t.nlad_transaction_date) AS min_transaction_date,
	t.id AS transaction_id,
	t.transaction_type 
FROM oss_nlad_transactions t 
WHERE t.enrollment_type IN ('EBB', 'ACP')
GROUP BY 1
),
t3 AS
(SELECT
	t1.customer_id,
	t1.created_at,
	t1.enrollment_id,
	t2.min_transaction_date,
	t2.transaction_id,
	t2.transaction_type
FROM t1 
LEFT JOIN t2 ON t1.enrollment_id = t2.enrollment_id
),
	
t4 AS
(
SELECT
	CASE 
		WHEN t3.created_at < t3.min_transaction_date THEN t3.created_at 
		WHEN t3.created_at > t3.min_transaction_date THEN t3.min_transaction_date 
		WHEN t3.created_at = t3.min_transaction_date THEN t3.created_at
		WHEN t3.min_transaction_date IS NULL THEN t3.created_at
		ELSE NULL END AS created_date,
		t3.customer_id,
		t3.enrollment_id
FROM t3 
)

SELECT
	DATE_FORMAT(t4.created_date,"%Y-%m") AS month_create,
	count(DISTINCT t4.enrollment_id) AS nb_customers
FROM t4
GROUP BY 1
ORDER BY 1 ASC
